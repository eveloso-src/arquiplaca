<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-spring3-3.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout">
<head>
<title>Home Page</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<link rel="stylesheet" type="text/css" th:href="@{/css/home.css}" />

<script>
	
</script>
</head>

<body>
	<script type="text/javascript" th:src="@{/js/utils.js}"></script>

	<header th:replace="layouts/base::header(dark)"> </header>

	<div class="container">
		<!-- 		<form id="logout" th:action="@{/logout}" method="get"> -->

		<div class="row"></div>
		<!-- 		</form> -->


		<div class="row">

			<div class="col-md-4">

				<div class="panel-group" style="margin-top: 40px">

					<div class="panel panel-primary">
						<div class="panel-heading">
							<b><span th:utext="'Nuevo Movimiento'"></span></b>
						</div>
						<div class="panel-body">

							<form id="form" th:action=" 
								@{/movement}"
								th:object="${movement}" method="post">
								<div class="row botton-padding">
									<div class="form-group col-md-4 capitalize">
										<b>Codigo: </b>
										
										<input type="text" class="form-control"
											id="code" th:field="*{product.code}" name="code" required />
									</div>
									<div class="form-group col-md-4 capitalize">
										<b>Color: </b><select id="color" th:field="*{product.color}" name="color" class="form-control">
											<option value="PZ">PZ</option>
											<option value="W/N">W/N</option>
											<option value="H/B">H/B</option>
											<option value="N/B">N/B</option>
											<option value="B">B</option>
											<option value="Z">Z</option>
											<option value="N">N</option>
											<option value="B/N">B/N</option>
											<option value="B/H">B/H</option>
										</select>
									</div>

									<div class="form-group col-md-12">
										<!-- 										<small> -->
										<div class="form-group capitalize" id="productDesc"></div>
										<!-- 										</small> -->
									</div>
								</div>
								<div class="row">
									<div class="form-group col-md-4">
										<b>Cantidad: </b><input type="number" class="form-control"
											name="amount" required id="amount" />
									</div>
									<div class="form-group col-md-4">
										<b>m2: </b><input type="number" class="form-control" name="m2"
											readonly id="m2" />
									</div>
									<div class="form-group col-md-4">
										<b>TOTAL m2: </b><input type="number" class="form-control"
											name="totalM2" readonly readonly id="totalM2" />
									</div>
								</div>
								<div class="row">
									<div class="form-group col-md-4">
										<b>Sucursal: </b><input type="text" class="form-control"
											name="branch" value="San Justo" id="branch" required />
									</div>

									<div class="form-group col-md-4">
										<b>Carpinteria: </b><input type="text" class="form-control"
											name="carpentry" id="carpentry" value="Ciudad Muebles" />
									</div>
									<div class="form-group col-md-4">
										<b>Estado: </b><input type="text" class="form-control"
											name="state" id="state" />
									</div>
								</div>

								<div class="row">
									<div class="form-group col-md-8">
										<b> Fecha:</b> <input type="date" required
											class="form-control" id="date" name="date" th:field="*{date}" />
									</div>
									<br>
									<div class="form-group col-md-4 capitalize">
										<button type="button" class="btn btn-primary" id="newMov">
											<b>Crear</b>
										</button>
									</div>
								</div>

							</form>
						</div>
					</div>
					<!--  
						-->
				</div>
			</div>
			<div class="col-md-8">

				<div class="panel-group" style="margin-top: 40px">


					<div class="panel panel-primary">
						<div class="panel-heading">
							<b><span th:utext="Movimientos"> </span></b>
						</div>

						<div class="panel-body">
							<table id="tableMovs"
								class="table w-auto text-xsmall table-striped table-responsive table-hover table-condensed">
								<thead>
									<tr>
										<th>Fecha</th>
										<th>Codigo</th>
										<th>Nombre</th>
										<th>Color</th>
										<th>Cantidad</th>
										<th>M2</th>
										<th>Estado</th>
										<th>Carpinteria</th>
										<th>Sucursal</th>
									</tr>
								</thead>
								<tr th:each="item,status: ${listmov}">
									<td th:text="${#dates.format(item.date, 'dd/MM/yyyy')}">
									<td th:text="${item.product.color}" />
									<td th:text="${item.product.description}" />
									<td th:text="${item.color}" />
									<td th:id="'td' + ${status.index}" th:text="${item.amount}" />
									<td th:text="${item.m2}" />
									<td th:text="${item.state}" />
									<td th:text="${item.carpentry}" />
									<td th:text="${item.branch}" />
								</tr>


							</table>
						</div>
					</div>
				</div>
			</div>

		</div>
	</div>
</body>
</html>

<script>
	function greenRed(cell) {
		if (cell.innerHTML > 0) {
			cell.style.backgroundColor = "#A8F894";
		} else {
			cell.style.backgroundColor = "#F98D6F";
		}
		cell.style.textAlign = "center";

	}
	let list = $('td[id^=td]');
	$.each(list, function(index, cell) {
		greenRed(cell);
	});
	
	$('#newMov')
			.click(
					function() {
						// 						validateForm();
// 												console.log($("form").serialize());
						$
								.ajax({
									type : 'POST',
									url : $("#form").attr("action"),
									data : $("form").serialize(),
									success : function(response) {
										// 				console.log("ok")
										// 				var table = $('#tableMovs');
										var table = document.getElementById(
												'tableMovs')
												.getElementsByTagName('tbody')[0];
										var row = table.insertRow(0);

										var cell1 = row.insertCell(0);
										var aux = document
												.getElementById('date').value;
										var fecha = aux.substring(8, 10) + '/'
												+ aux.substring(5, 7) + '/'
												+ aux.substring(0, 4);
										cell1.innerHTML = fecha;

										addRow(row, 'code');
										let cell3 = row.insertCell(2);
										let node = document
												.getElementById("productDesc").innerHTML;
										cell3.appendChild(document
												.createTextNode(node.replace(
														"<br>", "")));

										var cell4 = row.insertCell(3);

										let colorText = document
												.getElementById("code").value;
										colorText = colorText.replace(/[0-9]/g,
												'');
										cell4.innerHTML = colorText;

										var cell5 = row.insertCell(4);
										cell5.innerHTML = document
												.getElementById('amount').value;
										greenRed(cell5);
										addRow(row, 'totalM2');
										addRow(row, 'state');
										addRow(row, 'carpentry');
										addRow(row, 'branch');

									},
									error : function(response) {
										console.log("error")
									}
								});
					});

	$('#amount').blur(
			function() {
				let amount = document.getElementById('amount').value;

				document.getElementById('totalM2').value = parseInt(amount, 10)
						* parseFloat(document.getElementById('m2').value);

			});

	// function searchProduct() {
	$('#code')
			.blur(

					function() {
						document.getElementById("code").value = document
								.getElementById("code").value.toUpperCase();

// 						console.log(document.getElementById("code").value
// 								+ document.getElementById("color").value);
						let code = document.getElementById("code").value
								+ document.getElementById("color").value;
						$
								.ajax({
									type : 'GET',
									url : '/searchProduct?color=' + code,
									// 		data : form,
									success : function(response) {

										document.getElementById('productDesc').innerHTML = '<br>'
												+ response;

										$
												.ajax({
													type : 'GET',
													url : '/searchM2?color='
															+ code,
													success : function(response) {
														document
																.getElementById("m2").value = response;

													},
													error : function(response) {
														console.log("error")
													}
												});

									},
									error : function(response) {
										console.log("error")
									}
								});
					});
	// }
</script>